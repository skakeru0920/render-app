# フルスタックデプロイ

## 背景

あなたは、共同利用型の画像編集ソフトを作成しました。ユーザーはピクセルをクリックして、黒と白を切り替えたり、他の人の編集内容をリアルタイムで見ることができます。  
とてもシンプルなプロトタイプは完成していますが、いよいよ投資家にこのプロトタイプを見せる段階に来ました！しかし、今このウェブアプリはあなたのローカル環境でしか動いていません。Node とPostgres のセットアップ方法を説明して、投資家に「自分のPCでローカルサーバーを立ててください」と頼むわけにはいきません。  
私たちがやるべきことは、このウェブアプリをインターネット上に公開して、誰でも簡単なURLからアクセスできるようにすることです。

## 目的

- Render を使ってプロジェクトをデプロイする流れを学ぶ
- 本番環境における設定（データベース接続、ポート設定など）の仕組みを理解する
- マイグレーションやその他の初期設定を、デプロイプロセスに組み込む方法を学ぶ

### 基礎演習

 #### プログラムの動作確認

- [ ] このレポジトリをクローンした後、 `npm install` を実行して必要なパッケージをインストールしてください。
- [ ] 次の作業では、ローカル環境で Postgres が起動している必要があります。Postgres のインスタンスを起動し、`ccpixels` という名前のデータベースを作成してください。
    > **補足**: データベースを作成するための `psql` クエリは `CREATE DATABASE ccpixels;` です。
- [ ] マイグレーションを実行して、データベースの状態を最新にしてください。このコマンドは `package.json` の `scripts` セクションに記載されています。
    > **注意**: この段階で一番多いエラーはデータベース接続エラーです。マイグレーションが失敗した場合は、Postgres が起動しているか、また `src/db/knexfile.js` に設定されている Postgresのユーザー名・パスワードが実際の環境と一致しているかを確認してください。
- [ ] シードデータ（初期データ）を投入しましょう。このコマンドも `package.json` の `scripts` セクションに記載されています。 
- [ ] `node src/index.js` を使ってアプリを起動し、ブラウザで `localhost` にアクセスしてください（ポート番号は `server.js` に記載されています）。
    - シードデータ投入後、どのような画像が表示されていますか？アプリを操作してどのように動作するか見ておきましょう。もし、画像が表示されていない場合は、シードデータの投入に失敗しています。
- [ ] `package.json` の "scripts" に `start` と `build` を追加します。
  ```json
    "scripts" {
        "build": "npm install",
        "start": "node ./src/index.js"
    }
  ```
 - [ ] 変更をコミットして、リモートリポジトリに push しておきましょう。
    - アプリケーションを Render にデプロイする前に設定を追加しておく必要があります。

#### Render: アカウントの作成

- [ ] [render.com](https://render.com) にアクセスし、最新の説明に従ってアカウントを作成してください。この際、有料プランにサインアップする必要はありません。
- [ ] Github のアカウントと接続し、リポジトリへのアクセスを許可してください。

#### Render: 新しい Web サービスの作成

- [ ] [Render dashboard](https://dashboard.render.com) にアクセスします。
- [ ] "Add new" ボタンをクリックします。
- [ ] "Web Service" を選択します。
- [ ] Github のリポジトリに接続し、リストからこのプロジェクトのリポジトリを選択します。
  - もしリストにリポジトリが表示されない場合は、Render アカウントの設定から Github リポジトリのアクセス権限を付与してください。
- [ ] "Name" にはユニークな名前を入力します。これがサービス名になります。
- [ ] "Language" は "Node" を選択します。
- [ ] "Branch" には `master` を入力します。
- [ ] "Region" は、自分の地理的位置に最も近いものを選んでください。
- [ ] "Root Directory" は空欄のままにします（デフォルトでこのプロジェクトのルートが設定されます）。
- [ ] "Build Command" は `npm run build` を入力します。
- [ ] "Start Command" は `npm start` と入力します。このコマンドが、サーバーを起動するスクリプトになります。
- [ ] "Instance Type" で "Free" プランが選択されていることを確認します。
  - Free プランの場合、Web サービスは 15 分間アクセスがないと自動的にスリープ状態になり、次のアクセス時に再起動します。[参考: Spinning down on idle](https://render.com/docs/free#spinning-down-on-idle)
- [ ] "Deploy Web Service" ボタンをクリックします。

#### Render: データベースの設定

- [ ] ダッシュボードから "Add new" をクリックし、今回は "Postgres" を選択します。
- [ ] "Name" にユニークな名前を入力します（例：PixelsPostgres）。
- [ ] "Database" に `ccpixels` と入力します。これがデータベース名になります。
- [ ] "User" には、覚えやすいユーザー名を入力します
- [ ] "Region" には、自分の地理的位置に最も近いものを選んでください。
- [ ] "PostgreSQL Version" を 14 に設定します。
- [ ] 他の設定はひとまず無視してください。
- [ ] "Instance Type" で "Free" プランが選択されていることを確認します。
  - 無料の PostgreSQL インスタンスは作成から 30 日後に期限切れとなり、その後 14 日以内に有料プランへアップグレードしない場合、データが削除されます。[参考:Free PostgreSQL instances now expire after 30 days (previously 90)](https://render.com/changelog/free-postgresql-instances-now-expire-after-30-days-previously-90?utm_source=chatgpt.com)
- [ ] "Create Database" ボタンをクリックします。
- [ ] ダッシュボードに戻り、データベースのステータスが "Available" になるまで待ちましょう。

#### Render: 環境変数の追加

これで Node サーバーとデータベースのデプロイは完了しました。しかし、両者を接続する設定がまだ必要です。そのためには、**環境変数（Environment Variable）** を設定して、Web サービスにデータベースの接続情報を教える必要があります。

Render Web サービスに `DATABASE_URL` という環境変数を追加しましょう。

- [ ] ダッシュボードから、先ほど作成した PostgreSQL データベースをクリックします。
- [ ] "Info" の "Connections" セクションから、"Internal Database URL" をコピーします。
- [ ] ダッシュボードに戻り、作成した Node の Web サービスをクリックします。
- [ ] "Environment Variables" の "Edit" をクリックします。
- [ ] "Add" をクリックし、"New variable" をクリックし、下記を貼り付けます。
  - [ ] "Key" に "DATABASE_URL" を入力。
  - [ ] "Value" に先ほどコピーした "Internal Database URL" を入力。
- [ ] "Save, rebuild, and deploy" をクリックします。これで新しい設定が反映されます。

#### デプロイ準備

ソースコードで使用しているポート番号は標準的なものではなく、本番環境（Render上）では動作しません。Render は自動でポート番号を割り当てます。しかし、Render が提供するポート番号をどのように取得して使用するのでしょうか？
  > 👉 ヒント：[Node.jsの `process.env` のドキュメント](https://nodejs.org/en/learn/command-line/how-to-read-environment-variables-from-nodejs) を調べてみましょう。

- [ ] Render で適切なポート番号を読み込めるようにコードを修正しましょう。

現状 `src/db/knexfile.js` の設定が 1 種類しかありませんが、これは良くありません。本番環境かローカル環境かによって適切な設定を切り替えるようにすべきです。
では、このデータベース接続情報はどのようにして取得するのでしょうか？ knexfile をどう変更すれば、環境によって適切な設定を読み込めるようになるでしょうか？

- [ ] 動作する環境によって適切な設定を切り替えることができるように `src/db/knexfile.js` を修正しましょう。

マイグレーションスクリプトは、リリース直前に自動実行されるべきです。どうやってこの機能を追加すればよいでしょうか？
  > 👉 ヒント：ビルドプロセス中にマイグレーションを実行する設定を考えてみましょう。

- [ ] ビルドプロセス中にマイグレーションを実行するように設定を追加しましょう。どのファイルにどのような記述を追加すれば良いか考えて修正してください。

- [ ] ここまでの変更分をブランチにコミットし、リモートリポジトリにプッシュしましょう！

#### デプロイ後の確認

- [ ] Web サービスページ上部に表示されているURLをクリックして、デプロイされたアプリを開きましょう。（URLは `<アプリ名>.onrender.com` のような形式になっています）
  - もしうまくいっていれば、アプリが正しく動作するはずです。お疲れ様でした！🎉
    > 😱 もしうまく動かなかった場合でも大丈夫です！デプロイではいろいろな失敗パターンがあり得るので、どちらにせよトラブル対応力をつけるチャンスです！

  - [ ] コードがデプロイされなかった場合、`git push` 実行にターミナル上でエラーが出ていなかったかを確認してください。
  - [ ] Render の Web サービスの `Logs` セクションを確認し、エラーメッセージが出ていないか確認しましょう。
    - 最もよくあるエラー原因は、データベース接続の失敗です。特に、knex の設定（knexfile.js）に問題がある場合は、マイグレーション実行時にエラーが出ます。
  - [ ] データベースは問題ないがフロントエンドでエラーが出ている場合、 **ブラウザの開発者コンソール（DevTools）** にエラーが表示されます。
  - [ ] バックエンドで問題が起きている場合、VS Codeのデバッガーでブレークポイントを張ることができないので調査が難しくなります。この場合、ログ出力を活用してデバッグしましょう。

- [ ] すべて動作確認できたら、**次は「新しいバージョンをリリース」** してみましょう！
  - [ ] フロントエンドのフォントを変更しましょう（Comic Sansはあまりにも「真面目」すぎます。ちなみに "Comic Sans" はラテン語で「面白くない」という意味です😉）
  - [ ] コードをブランチにコミットして、もう一度、これまでと同じ手順でRenderへ再デプロイしてください！

> [!IMPORTANT]
> Renderの無料プランには利用制限があります。この課題の作業が完了したら、作成したWebサービスとデータベースは必ず一時停止（Suspend）してください。

### 応用演習

Render 上にデプロイしたアプリは投資家に好評でした！しかし、彼らは出資する前にもっと他の機能も見せてほしいと言っています。  

> 💡 この演習での目的は「デプロイ作業に慣れること」です。Render への再デプロイや、SQL スキーマをマイグレーションで変更する練習を兼ねています。以下の機能追加はあくまで提案なので、他にもスキーマ変更が発生する内容であればこれに限らず挑戦してみましょう。

#### 🚀 機能追加案

- [ ] 黒と白の2色だけでなく、16色から選べるようにしましょう。
  - 現在ピクセルの色は boolean 型で管理されていますが、これを数値型に変更する必要があります。
- [ ] ボタングリッドをやめて、Canvas 上で直接クリックして描画できるように変更しましょう。
  - ボタン式のUIは時代遅れです。投資家はグリッドでボタンを作るより、直接クリックできる Canvas に換えることを望んでいます。
- [ ] ユーザーのIPアドレスごとに 1 分間に 1 ピクセルしか変更できない制限を追加してください。
  - これはサーバー側で制御すべきで、クライアント側ではありません。
  - 例えば、IP アドレスと変更時間を記録する新しいテーブルを作成する方法が考えられます。

#### 🔥 その他、試してみたい Render 機能
- [ ] Render上の本番データベースに、コマンドラインから接続する方法を調べてみる。
  - マイグレーションの失敗原因を調べたり、データを直接確認するのに便利です。
- [ ] アプリが大人気でサーバー負荷が高くなった場合、Render上でリソースを拡張する方法を調べてみる。
  - どの設定を変更すればスケールできるでしょうか？
