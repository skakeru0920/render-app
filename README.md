# デプロイメントスプリント

## 背景

あなたは、共同利用型の画像編集ソフトを作成しました。ユーザーがピクセルをクリックして白黒を切り替えることができ、また他の人が行った編集をリアルタイムで見ることができるアプリです。今はまだあなたのマシン上でローカルに作成しています。シンプルなプロトタイプを動作させていますが、そろそろ投資家に見せる時期になってきました。Node とPostgres のセットアップ方法を説明して、彼らのマシン上でサーバーを実行して見てもらう、などということは到底無理ですので、Web アプリケーションをオンラインで公開し、便利な URL からアクセスしてもらうようにしなければいけません。

## 目的

このタスクの目標は...

- Render 上でのプロジェクトのデプロイメントを学ぶ。
- 実際の本番環境におけるデータベースやポートなどの設定の仕組みを理解する。
- デプロイメントの一部としてマイグレーションやその他のセットアップをどのように行うかを学ぶ。

### 基礎演習

- [ ] まず、プログラムが動作することを確認します。

  - [ ] このレポジトリをクローンした後、 `npm install` を使って必要なパッケージをインストールします。
  - [ ] 次の作業では、あなたのマシン上で Postgres がローカルに動作していることが必要です。Postgres のインスタンスが走っていることを確認し、`ccpixels` というデータベースを作成してください。
     > **ヒント**: データベースを作成するための `psql` クエリは `CREATE DATABASE ccpixels;` です。
  - [ ] データベースを最新の状態にするためにマイグレーションを実行します。このコマンドは `package.json` の `scripts` セクションに記載されています。
    - この段階での最も一般的なエラーは、データベース接続エラーです。マイグレーションが実行できない場合は、Postgres が起動していることと、Postgres のユーザー名とパスワードが `src/db/knexfile.js` にある設定と一致していることを確認してください。
  - [ ] シードデータを実行します。このコマンドも `package.json` の `scripts` セクションに記載されています。 
  - [ ] `node src/index.js` を使ってアプリを起動し、ブラウザで `localhost` (ポートは `server.js` に記載) を使ってアクセスします。シードデータを実行した後、どのような画像が表示されますか？もし、画像が表示されない場合は、シードデータが機能しなかったということです。また、イメージエディタを触ってみて、アプリがどのように動作するか、挙動を確認してみてください。
- [ ] Renderのアカウントを取得する。
  - [ ] [render.com](https://render.com) にアクセスし、最新の説明に従ってアカウントを設定してください。この際、有料プランにサインアップする必要はありません。

    - Github のアカウントと接続し、リポジトリへのアクセスを許可してください。
- [ ] 新しい Web サービスを作成します。
  - [ ] [Render dashboard](https://dashboard.render.com) にアクセスします。

  - [ ] "New" ボタンをクリックします。
  - [ ] "Web Service" を選択します。
  - [ ] Github のリポジトリに接続し、リストからこのリポジトリを選択します。
    - このリポジトリが選択肢にない場合は、Github のリポジトリにアクセスする権限を Render に付与するようにアカウントを設定してください。
  - [ ] "Name" は他で使っていない名前を入力します。
  - [ ] ルートディレクトリは空のままにします。（デフォルトでこのプロジェクトのルートになります。）
  - [ ] "Environment" は "Node" を選択します。
  - [ ] "Region" は、あなたがいる場所に最も近いものを選択します。
  - [ ] "Branch" には、`master`を入力します。
- [ ] " Build Command" は `npm run build` を入力します。
  - [ ] "Start Command" は `npm start` と入力します。
    - これはサーバーを起動するスクリプトです。
  - [ ] "Free"プランが選択されていることを確認します。このプランの有効期限は90日間です。
  - [ ] "Create Web Service" ボタンをクリックします。
  - [ ] アプリケーションをデプロイする前に、`build` と `start` スクリプトを `package.json` に追加する必要があります。
  - [ ] `package.json` の "scripts" に `start` と `build` を追加します。
    ```json
      "scripts" {
          "build": "npm install",
          "start": "node ./src/index.js"
      }
    ```
 次にデータベースの設定を行います。
- [ ] データベースを作成します。
  - [ ] ダッシュボードで "New" をクリックし、今回は "PostgreSQL" を選択します。
  - [ ] 一意の名前を付けます。（例：PixelsPostgres）
  - [ ] データベースフィールドに `ccpixels` と入力します。
  - [ ] "User" フィールドに覚えやすいユーザー名を入力します
  - [ ] "Region" フィールドには、最も近いリージョンを選択します。
  - [ ] "PostgreSQL version" を 14 に設定します。
  - [ ] 他の設定はひとまず無視してください。
  - [ ] "Free" プランが選択されていることを確認します。
  - [ ] "Create Database" ボタンをクリックします。
  - [ ] ダッシュボードに戻り、データベースのステータスが "Available" に変わるのを待ちます。

これで Node サーバーとデータベースが設定されました。次はそこと接続する必要があります。
そのためには、Web サービスにデータベースへの接続方法を伝えるため、環境変数を設定する必要があります。

- Render Web サービスに DATABASE_URL という環境変数を追加します。
  - [ ] ダッシュボードから、作成した PostgreSQL データベースをクリックします。
  - [ ] " Info" タブの "Connections" セクションから、"Internal Database URL" をコピーします。
  - [ ] Render のダッシュボードに戻り、作成した Node の Web サービスをクリックします。
  - [ ] "Environment" タブをクリックします。
  - [ ] "Add Environment Variable"をクリックします。
  - [ ] "Key"に "DATABASE_URL "を入力します。
  - [ ] "Value" に先ほどコピーした "Internal Database URL"を貼り付けます。
  - [ ] "Save Changes" をクリックします。

- [ ] デプロイメントの準備をしましょう
  - [ ] ソースコードで使用しているポート番号は標準的なものではなく、本番では動作しません。ポート番号は Render が選択してくれます。Render が提供するポート番号にどのようにアクセスし、使用するのでしょうか？ヒント: Nodeの `process.env` ドキュメントを調べてみてください。
  - [ ] `src/db/knexfile.js` の設定が1つだけになっていますがこれは良くありません。knexfile は本番環境で動作しているかどうかによって、異なる設定を返す必要があります。このデータベース接続情報はどこから来るのでしょうか？この情報を使用するように knexfile を設定するにはどうしたらよいでしょうか？
  - [ ] リリースがデプロイできるようになったらマイグレーションスクリプトを実行しなければいけません。この機能をどう追加すればよいでしょう。ヒント：マイグレーションスクリプトはビルドの過程で走らせたいですよね。
  - [ ] ここまでブランチに加えた変更のコミットがまだなら、コミットしてください。
- [ ] リモートリポジトリに `git push origin master`でコードをプッシュします。
- [ ] Web サービスページの上部にある URL をクリックすると、デプロイされたアプリが表示されます。（`<あなたのアプリ名>.onrender.com`のような感じです。）
  - 上手く行ったら、おめでとうございます！アプリは機能するでしょう。お疲れ様でした。
    > うまくいきませんでしたか？ やるべき項目が沢山ですからね！うまくいってもいかなくても、どこを確認したらいいかを知っておきましょう。
      - コードがデプロイされなかった場合は、git push したときにターミナル上でエラーが出ていなかったか確認します。
      - Web サービスの `Logs` セクションをチェックし、エラーメッセージを読みましょう。
      - エラーの原因として最も多いのは、データベースが正しく接続されていないことです。knex の設定にエラーがある場合は、マイグレーションを実行しようとすると`Logs`セクションに表示されます。
      - データベースが動作していて、フロントエンドでエラーが発生した場合、ブラウザの開発者コンソールにエラーが表示されます。
      - バックエンドに問題がある場合、VS Codeのデバッガでコードにブレークポイントを置くことができなくなるため、難しくなります。この場合、ログを使用する必要があります。
  - [ ] ひとまず動作するようになったら新バージョンをリリースしてみましょう。Comic Sans はちょっと固い感じ（まぁラテン語だとオモシロクナイという意味になりますし...）なのでフロントエンドのフォントを変更しましょう。 コードをブランチにコミットし、先ほどの手順でRenderに再デプロイしてください。

**重要**　Renderの無料枠には上限がありますのでこのスプリントが終わったら、作ったWebサービスとデータベースは必ず一時停止（suspend）してください！

### 応用演習

Renderにデプロイされたアプリは投資家から好評を得ました。しかし、彼らは投資する前にもっと他の機能の実装も見たいと言っています。Renderへの再デプロイメントやマイグレーションでSQLスキーマを変更する練習に使ってください。

> この演習の目的はデプロイメントに慣れることです。以下は例えばこんな機能も考えられるとあげているだけですので、 SQL スキーマを変更するような内容であればこれに限らずやってみてください。

- [ ] 白と黒だけでなく、16色から選べるようにする。ピクセルのスキーマは現在ブーリアンになっていますが、数値に変更する必要があります
- [ ] ボタンはいかにも2021年風です。もっと未来的なモノがほしい！そして、未来といえばやはり DOM Canvas でしょう。投資家はグリッドでボタンを作るより、直接クリックできる canvas に換えることを望んでいます。
- [ ] ユーザーが1つのIPアドレスあたりに行えるピクセル変更の回数を1分間に1回に制限してください。これはクライアントではなく、サーバー側で制御しましょう。これで例えばユーザーが画像を編集するために複数のタブを開くことを防ぐことができます。おそらく最良のアプローチはユーザーのIPアドレスと変更を行った回数を記録する新しいテーブルを作成することです。

その他、探索してみたい Render 機能
- [ ] コマンドラインから本番データベースに接続する方法は？これは、マイグレーションが失敗しているかどうかを判断したり、データをチェックしたりするのに使えるかもしれません。
- [ ] この共同ピクセル編集アプリがトラフィックによって過負荷になっているとしたら、Render からより多くのリソースを割り当てて、スケールできるようにするにはどうしたらよいでしょう？
